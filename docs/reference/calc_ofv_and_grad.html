<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Compute an objective function and gradient — calc_ofv_and_grad • PopED</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Compute an objective function and gradient — calc_ofv_and_grad" />

<meta property="og:description" content="Compute an objective function and gradient with respect to the optimization parameters.
This function can be passed to the Broyden Fletcher Goldfarb Shanno (BFGS) 
method for nonlinear minimization with box constraints implemented in bfgsb_min." />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PopED</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.4.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/intro-poped.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/examples.html">Examples</a>
    </li>
    <li>
      <a href="../articles/intro-poped.html">Introduction to PopED</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/andrewhooker/PopED">
    <span class="fa fa-github"></span>
     
    Source
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute an objective function and gradient</h1>
    
    <div class="hidden name"><code>calc_ofv_and_grad.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>Compute an objective function and gradient with respect to the optimization parameters.
This function can be passed to the Broyden Fletcher Goldfarb Shanno (BFGS) 
method for nonlinear minimization with box constraints implemented in <code><a href='bfgsb_min.html'>bfgsb_min</a></code>.</p>
    
    </div>

    <pre class="usage"><span class='fu'>calc_ofv_and_grad</span>(<span class='no'>x</span>, <span class='no'>optxt</span>, <span class='no'>opta</span>, <span class='no'>model_switch</span>, <span class='no'>aa</span>, <span class='no'>axt</span>, <span class='no'>groupsize</span>, <span class='no'>ni</span>,
  <span class='no'>xtopto</span>, <span class='no'>xopto</span>, <span class='no'>aopto</span>, <span class='no'>bpop</span>, <span class='no'>d</span>, <span class='no'>sigma</span>, <span class='no'>docc_full</span>, <span class='no'>poped.db</span>,
  <span class='kw'>only_fim</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>A matrix for the discrete design variables.  Each row is a group.</p></td>
    </tr>
    <tr>
      <th>optxt</th>
      <td><p>If sampling times are optimized</p></td>
    </tr>
    <tr>
      <th>opta</th>
      <td><p>If continuous design variables are optimized</p></td>
    </tr>
    <tr>
      <th>model_switch</th>
      <td><p>A matrix that is the same size as xt, specifying which model each sample belongs to.</p></td>
    </tr>
    <tr>
      <th>aa</th>
      <td><p>The aa value</p></td>
    </tr>
    <tr>
      <th>axt</th>
      <td><p>the axt value</p></td>
    </tr>
    <tr>
      <th>groupsize</th>
      <td><p>A vector of the number of individuals in each group.</p></td>
    </tr>
    <tr>
      <th>ni</th>
      <td><p>A vector of the number of samples in each group.</p></td>
    </tr>
    <tr>
      <th>xtopto</th>
      <td><p>the xtopto value</p></td>
    </tr>
    <tr>
      <th>xopto</th>
      <td><p>the xopto value</p></td>
    </tr>
    <tr>
      <th>aopto</th>
      <td><p>the aopto value</p></td>
    </tr>
    <tr>
      <th>bpop</th>
      <td><p>Matrix defining the fixed effects, per row (row number = parameter_number) we should have:</p><ul>
<li><p>column 1 the type of the distribution for E-family designs (0 = Fixed, 1 = Normal, 2 = Uniform,
 3 = User Defined Distribution, 4 = lognormal and 5 = truncated normal)</p></li>
<li><p>column 2  defines the mean.</p></li>
<li><p>column 3 defines the variance of the distribution (or length of uniform distribution).</p></li>
</ul><p>Can also just supply the parameter values as a vector <code>c()</code> if no uncertainty around the 
parameter value is to be used.</p></td>
    </tr>
    <tr>
      <th>d</th>
      <td><p>Matrix defining the diagonals of the IIV (same logic as for the fixed effects 
matrix bpop to define uncertainty). One can also just supply the parameter values as a <code>c()</code>.</p></td>
    </tr>
    <tr>
      <th>sigma</th>
      <td><p>Matrix defining the variances can covariances of the residual variability terms of the model.
can also just supply the diagonal parameter values (variances) as a <code>c()</code>.</p></td>
    </tr>
    <tr>
      <th>docc_full</th>
      <td><p>A between occasion variability matrix.</p></td>
    </tr>
    <tr>
      <th>poped.db</th>
      <td><p>A PopED database.</p></td>
    </tr>
    <tr>
      <th>only_fim</th>
      <td><p>Should the gradient be calculated?</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list containing:</p>
<dt>f</dt><dd><p>The objective function.</p></dd>
<dt>g</dt><dd><p>The gradient.</p></dd>

    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Other Optimize: <code><a href='Doptim.html'>Doptim</a></code>,
  <code><a href='LEDoptim.html'>LEDoptim</a></code>, <code><a href='RS_opt.html'>RS_opt</a></code>,
  <code><a href='a_line_search.html'>a_line_search</a></code>, <code><a href='bfgsb_min.html'>bfgsb_min</a></code>,
  <code><a href='calc_autofocus.html'>calc_autofocus</a></code>, <code><a href='mfea.html'>mfea</a></code>,
  <code><a href='optim_ARS.html'>optim_ARS</a></code>, <code><a href='optim_LS.html'>optim_LS</a></code>,
  <code><a href='poped_optim_1.html'>poped_optim_1</a></code>, <code><a href='poped_optim_2.html'>poped_optim_2</a></code>,
  <code><a href='poped_optim_3.html'>poped_optim_3</a></code>,
  <code><a href='poped_optimize.html'>poped_optimize</a></code>, <code><a href='poped_optim.html'>poped_optim</a></code></p></div>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='fu'>library</span>(<span class='no'>PopED</span>)

<span class='co'>############# START #################</span>
<span class='co'>## Create PopED database</span>
<span class='co'>## (warfarin model for optimization)</span>
<span class='co'>#####################################</span>

<span class='co'>## Warfarin example from software comparison in:</span>
<span class='co'>## Nyberg et al., "Methods and software tools for design evaluation </span>
<span class='co'>##   for population pharmacokinetics-pharmacodynamics studies", </span>
<span class='co'>##   Br. J. Clin. Pharm., 2014. </span>

<span class='co'>## Optimization using an additive + proportional reidual error  </span>
<span class='co'>## to avoid sample times at very low concentrations (time 0 or very late samples).</span>

<span class='co'>## find the parameters that are needed to define from the structural model</span>
<span class='no'>ff.PK.1.comp.oral.sd.CL</span></div><div class='output co'>#&gt; function(model_switch,xt,parameters,poped.db){
#&gt;   ##-- Model: One comp first order absorption
#&gt;   with(as.list(parameters),{
#&gt;     y=xt
#&gt;     y=(DOSE*Favail*KA/(V*(KA-CL/V)))*(exp(-CL/V*xt)-exp(-KA*xt))
#&gt;     return(list( y= y,poped.db=poped.db))
#&gt;   })
#&gt; }
#&gt; &lt;environment: namespace:PopED&gt;</div><div class='input'>
<span class='co'>## -- parameter definition function </span>
<span class='co'>## -- names match parameters in function ff</span>
<span class='no'>sfg</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>x</span>,<span class='no'>a</span>,<span class='no'>bpop</span>,<span class='no'>b</span>,<span class='no'>bocc</span>){
  <span class='no'>parameters</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='kw'>CL</span><span class='kw'>=</span><span class='no'>bpop</span>[<span class='fl'>1</span>]*<span class='fu'>exp</span>(<span class='no'>b</span>[<span class='fl'>1</span>]),
               <span class='kw'>V</span><span class='kw'>=</span><span class='no'>bpop</span>[<span class='fl'>2</span>]*<span class='fu'>exp</span>(<span class='no'>b</span>[<span class='fl'>2</span>]),
               <span class='kw'>KA</span><span class='kw'>=</span><span class='no'>bpop</span>[<span class='fl'>3</span>]*<span class='fu'>exp</span>(<span class='no'>b</span>[<span class='fl'>3</span>]),
               <span class='kw'>Favail</span><span class='kw'>=</span><span class='no'>bpop</span>[<span class='fl'>4</span>],
               <span class='kw'>DOSE</span><span class='kw'>=</span><span class='no'>a</span>[<span class='fl'>1</span>])
  <span class='fu'>return</span>(<span class='no'>parameters</span>)
}

<span class='co'>## -- Define initial design  and design space</span>
<span class='no'>poped.db</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='create.poped.database.html'>create.poped.database</a></span>(<span class='kw'>ff_fun</span><span class='kw'>=</span><span class='no'>ff.PK.1.comp.oral.sd.CL</span>,
                                  <span class='kw'>fg_fun</span><span class='kw'>=</span><span class='no'>sfg</span>,
                                  <span class='kw'>fError_fun</span><span class='kw'>=</span><span class='no'>feps.add.prop</span>,
                                  <span class='kw'>bpop</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='kw'>CL</span><span class='kw'>=</span><span class='fl'>0.15</span>, <span class='kw'>V</span><span class='kw'>=</span><span class='fl'>8</span>, <span class='kw'>KA</span><span class='kw'>=</span><span class='fl'>1.0</span>, <span class='kw'>Favail</span><span class='kw'>=</span><span class='fl'>1</span>),
                                  <span class='kw'>notfixed_bpop</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='fl'>1</span>,<span class='fl'>1</span>,<span class='fl'>1</span>,<span class='fl'>0</span>),
                                  <span class='kw'>d</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='kw'>CL</span><span class='kw'>=</span><span class='fl'>0.07</span>, <span class='kw'>V</span><span class='kw'>=</span><span class='fl'>0.02</span>, <span class='kw'>KA</span><span class='kw'>=</span><span class='fl'>0.6</span>),
                                  <span class='kw'>sigma</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='fl'>0.01</span>,<span class='fl'>0.25</span>),
                                  <span class='kw'>groupsize</span><span class='kw'>=</span><span class='fl'>32</span>,
                                  <span class='kw'>xt</span><span class='kw'>=</span><span class='fu'>c</span>( <span class='fl'>0.5</span>,<span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>6</span>,<span class='fl'>24</span>,<span class='fl'>36</span>,<span class='fl'>72</span>,<span class='fl'>120</span>),
                                  <span class='kw'>minxt</span><span class='kw'>=</span><span class='fl'>0.01</span>,
                                  <span class='kw'>maxxt</span><span class='kw'>=</span><span class='fl'>120</span>,
                                  <span class='kw'>a</span><span class='kw'>=</span><span class='fl'>70</span>,
                                  <span class='kw'>mina</span><span class='kw'>=</span><span class='fl'>0.01</span>,
                                  <span class='kw'>maxa</span><span class='kw'>=</span><span class='fl'>100</span>)

<span class='co'>############# END ###################</span>
<span class='co'>## Create PopED database</span>
<span class='co'>## (warfarin model for optimization)</span>
<span class='co'>#####################################</span>


<span class='no'>opta</span><span class='kw'>=</span><span class='fl'>TRUE</span>
<span class='no'>aa</span><span class='kw'>=</span><span class='no'>opta</span>*<span class='no'>poped.db</span>$<span class='no'>settings</span>$<span class='no'>cfaa</span>*<span class='fu'>matrix</span>(<span class='fl'>1</span>,<span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>m</span>,<span class='fu'><a href='size.html'>size</a></span>(<span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>a</span>,<span class='fl'>2</span>))
<span class='no'>aa</span></div><div class='output co'>#&gt;       [,1]
#&gt; [1,] 0.001</div><div class='input'>
<span class='no'>optxt</span><span class='kw'>=</span><span class='fl'>TRUE</span>
<span class='no'>axt</span><span class='kw'>=</span><span class='no'>optxt</span>*<span class='no'>poped.db</span>$<span class='no'>settings</span>$<span class='no'>cfaxt</span>*<span class='fu'>matrix</span>(<span class='fl'>1</span>,<span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>m</span>,<span class='fu'>max</span>(<span class='no'>poped.db</span>$<span class='no'>design_space</span>$<span class='no'>maxni</span>))
<span class='no'>axt</span></div><div class='output co'>#&gt;       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
#&gt; [1,] 0.001 0.001 0.001 0.001 0.001 0.001 0.001 0.001</div><div class='input'>
<span class='fu'>calc_ofv_and_grad</span>(<span class='kw'>x</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>xt</span>,<span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>a</span>),
                  <span class='kw'>optxt</span><span class='kw'>=</span><span class='no'>optxt</span>, <span class='kw'>opta</span><span class='kw'>=</span><span class='no'>opta</span>,
                  <span class='kw'>model_switch</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>model_switch</span>,
                  <span class='kw'>aa</span><span class='kw'>=</span><span class='no'>aa</span>,
                  <span class='kw'>axt</span><span class='kw'>=</span><span class='no'>axt</span>,
                  <span class='kw'>groupsize</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>groupsize</span>,
                  <span class='kw'>ni</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>ni</span>,
                  <span class='kw'>xtopto</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>xt</span>,
                  <span class='kw'>xopto</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>x</span>,
                  <span class='kw'>aopto</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>design</span>$<span class='no'>a</span>,
                  <span class='kw'>bpop</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>parameters</span>$<span class='no'>param.pt.val</span>$<span class='no'>bpop</span>,
                  <span class='kw'>d</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>parameters</span>$<span class='no'>param.pt.val</span>$<span class='no'>d</span>,
                  <span class='kw'>sigma</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>parameters</span>$<span class='no'>param.pt.val</span>$<span class='no'>sigma</span>,
                  <span class='kw'>docc_full</span><span class='kw'>=</span><span class='no'>poped.db</span>$<span class='no'>parameters</span>$<span class='no'>param.pt.val</span>$<span class='no'>docc</span>,
                  <span class='no'>poped.db</span>,
                  <span class='kw'>only_fim</span><span class='kw'>=</span><span class='fl'>FALSE</span>)</div><div class='output co'>#&gt; $f
#&gt; [1] -55.39645
#&gt; 
#&gt; $g
#&gt;               [,1]
#&gt;  [1,]  0.079631592
#&gt;  [2,] -0.025697632
#&gt;  [3,] -0.312973640
#&gt;  [4,]  0.009484126
#&gt;  [5,]  0.019485344
#&gt;  [6,] -0.001675732
#&gt;  [7,] -0.009543726
#&gt;  [8,] -0.001929126
#&gt;  [9,] -0.035843401
#&gt; </div><div class='input'>
</div><span class='co'># NOT RUN {</span>

  <span class='co'># BFGS search, DOSE and sample time optimization</span>
  <span class='no'>bfgs.output</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='poped_optimize.html'>poped_optimize</a></span>(<span class='no'>poped.db</span>,<span class='kw'>opt_xt</span><span class='kw'>=</span><span class='fl'>1</span>,<span class='kw'>opt_a</span><span class='kw'>=</span><span class='fl'>1</span>,
                                <span class='kw'>bUseRandomSearch</span><span class='kw'>=</span> <span class='fl'>0</span>,
                                <span class='kw'>bUseStochasticGradient</span> <span class='kw'>=</span> <span class='fl'>0</span>,
                                <span class='kw'>bUseBFGSMinimizer</span> <span class='kw'>=</span> <span class='fl'>1</span>,
                                <span class='kw'>bUseLineSearch</span> <span class='kw'>=</span> <span class='fl'>0</span>)

<span class='co'># }</span><div class='input'>



</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by <a href='http://katalog.uu.se/empinfo/?languageId=1&id=N4-631'>Andrew C. Hooker</a>, Marco Foracchia, Sebastian Ueckert, Joakim Nyberg.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

